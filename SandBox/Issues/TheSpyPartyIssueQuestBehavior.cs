using System;
using System.Collections.Generic;
using System.Linq;
using Helpers;
using SandBox.Conversation.MissionLogics;
using TaleWorlds.CampaignSystem;
using TaleWorlds.CampaignSystem.Actions;
using TaleWorlds.CampaignSystem.AgentOrigins;
using TaleWorlds.CampaignSystem.Encounters;
using TaleWorlds.CampaignSystem.GameMenus;
using TaleWorlds.CampaignSystem.GameState;
using TaleWorlds.CampaignSystem.Issues;
using TaleWorlds.CampaignSystem.MapEvents;
using TaleWorlds.CampaignSystem.Party;
using TaleWorlds.CampaignSystem.Roster;
using TaleWorlds.CampaignSystem.Settlements;
using TaleWorlds.CampaignSystem.Settlements.Locations;
using TaleWorlds.Core;
using TaleWorlds.Library;
using TaleWorlds.Localization;
using TaleWorlds.MountAndBlade;
using TaleWorlds.ObjectSystem;
using TaleWorlds.SaveSystem;

namespace SandBox.Issues;

public class TheSpyPartyIssueQuestBehavior : CampaignBehaviorBase
{
	public class TheSpyPartyIssueQuestTypeDefiner : SaveableTypeDefiner
	{
		public TheSpyPartyIssueQuestTypeDefiner()
			: base(121250)
		{
		}

		protected override void DefineClassTypes()
		{
			AddClassDefinition(typeof(TheSpyPartyIssue), 1);
			AddClassDefinition(typeof(TheSpyPartyIssueQuest), 2);
		}

		protected override void DefineStructTypes()
		{
			AddStructDefinition(typeof(SuspectNpc), 3);
		}
	}

	public struct SuspectNpc
	{
		[SaveableField(10)]
		public readonly CharacterObject CharacterObject;

		[SaveableField(20)]
		public readonly bool HasHair;

		[SaveableField(30)]
		public readonly bool HasBigSword;

		[SaveableField(40)]
		public readonly bool WithoutMarkings;

		[SaveableField(50)]
		public readonly bool HasBeard;

		public SuspectNpc(CharacterObject characterObject, bool hasHair, bool hasBigSword, bool withoutMarkings, bool hasBeard)
		{
			CharacterObject = characterObject;
			HasHair = hasHair;
			HasBigSword = hasBigSword;
			WithoutMarkings = withoutMarkings;
			HasBeard = hasBeard;
		}

		public static void AutoGeneratedStaticCollectObjectsSuspectNpc(object o, List<object> collectedObjects)
		{
			((SuspectNpc)o).AutoGeneratedInstanceCollectObjects(collectedObjects);
		}

		private void AutoGeneratedInstanceCollectObjects(List<object> collectedObjects)
		{
			collectedObjects.Add(CharacterObject);
		}

		internal static object AutoGeneratedGetMemberValueCharacterObject(object o)
		{
			return ((SuspectNpc)o).CharacterObject;
		}

		internal static object AutoGeneratedGetMemberValueHasHair(object o)
		{
			return ((SuspectNpc)o).HasHair;
		}

		internal static object AutoGeneratedGetMemberValueHasBigSword(object o)
		{
			return ((SuspectNpc)o).HasBigSword;
		}

		internal static object AutoGeneratedGetMemberValueWithoutMarkings(object o)
		{
			return ((SuspectNpc)o).WithoutMarkings;
		}

		internal static object AutoGeneratedGetMemberValueHasBeard(object o)
		{
			return ((SuspectNpc)o).HasBeard;
		}
	}

	public class TheSpyPartyIssue : IssueBase
	{
		private const int QuestDurationInDays = 16;

		private const int RequiredSkillValue = 150;

		private const int AlternativeSolutionTroopTierRequirement = 2;

		[SaveableField(10)]
		private readonly Settlement _selectedSettlement;

		public override AlternativeSolutionScaleFlag AlternativeSolutionScaleFlags => AlternativeSolutionScaleFlag.FailureRisk;

		protected override int CompanionSkillRewardXP => (int)(600f + 800f * base.IssueDifficultyMultiplier);

		public override bool IsThereAlternativeSolution => true;

		public override bool IsThereLordSolution => false;

		public override int AlternativeSolutionBaseNeededMenCount => 1 + TaleWorlds.Library.MathF.Ceiling(4f * base.IssueDifficultyMultiplier);

		protected override int AlternativeSolutionBaseDurationInDaysInternal => 3 + TaleWorlds.Library.MathF.Ceiling(3f * base.IssueDifficultyMultiplier);

		protected override int RewardGold => (int)(500f + 3000f * base.IssueDifficultyMultiplier);

		public override TextObject IssueBriefByIssueGiver
		{
			get
			{
				TextObject textObject = new TextObject("{=tFPJySG7}I am hosting a tournament at {SELECTED_SETTLEMENT}. [ib:convo_undecided_open][if:convo_pondering]I am expecting contenders to partake from all over the realm. I have my reasons to believe one of the attending warriors is actually a spy, sent to gather information about its defenses.");
				textObject.SetTextVariable("SELECTED_SETTLEMENT", _selectedSettlement.EncyclopediaLinkWithName);
				return textObject;
			}
		}

		public override TextObject IssueAcceptByPlayer => new TextObject("{=EYT7b2J5}Any traveler can be asked by an enemy to spy on the places he travels. How can I track this one down?");

		public override TextObject IssueQuestSolutionExplanationByIssueGiver
		{
			get
			{
				TextObject textObject = new TextObject("{=2lgkL9db}Of course. I have employed spies myself. But if a tournament [if:convo_pondering][ib:confident3]participant is asking questions about the state of the garrison and the walls, things which would concern no honest traveler - well, between that and the private information I've received, I think we'd have our man. The spy must be hiding inside {SELECTED_SETTLEMENT}. Once you are there start questioning the townsfolk.");
				textObject.SetTextVariable("SELECTED_SETTLEMENT", _selectedSettlement.EncyclopediaLinkWithName);
				return textObject;
			}
		}

		public override TextObject IssuePlayerResponseAfterAlternativeExplanation => new TextObject("{=2nFBTmao}Is there any other way to solve this other than asking around?");

		public override TextObject IssueAlternativeSolutionExplanationByIssueGiver
		{
			get
			{
				TextObject textObject = new TextObject("{=avVno3H8}Well, you can assign a companion of yours with a knack for this kind of game[if:convo_thinking] and enough muscles to back him up. Judging from what I have heard, a group of {NEEDED_MEN_COUNT} should be enough.");
				textObject.SetTextVariable("NEEDED_MEN_COUNT", GetTotalAlternativeSolutionNeededMenCount());
				return textObject;
			}
		}

		public override TextObject IssueQuestSolutionAcceptByPlayer => new TextObject("{=99OsuHGa}I will find the one you are looking for.");

		public override TextObject Title => new TextObject("{=SJHtVaNa}The Spy Among Us");

		public override TextObject Description
		{
			get
			{
				TextObject textObject = new TextObject("{=C6rbcpbi}{QUEST_GIVER.LINK} wants you to find a spy before he causes any harm...");
				StringHelpers.SetCharacterProperties("QUEST_GIVER", base.IssueOwner.CharacterObject, textObject);
				return textObject;
			}
		}

		public override TextObject IssueAlternativeSolutionAcceptByPlayer
		{
			get
			{
				TextObject textObject = new TextObject("{=FEcAwSfk}I will assign a companion with {NEEDED_MEN_COUNT} good men for {ALTERNATIVE_SOLUTION_DURATION} days.");
				textObject.SetTextVariable("NEEDED_MEN_COUNT", GetTotalAlternativeSolutionNeededMenCount());
				textObject.SetTextVariable("ALTERNATIVE_SOLUTION_DURATION", GetTotalAlternativeSolutionDurationInDays());
				return textObject;
			}
		}

		public override TextObject IssueDiscussAlternativeSolution => new TextObject("{=O0Cjam62}I hope your people are careful about how they proceed.[if:convo_focused_happy] It would be a pity if that spy got away.");

		public override TextObject IssueAlternativeSolutionResponseByIssueGiver
		{
			get
			{
				TextObject textObject = new TextObject("{=ciXBiMMa}Thank you {PLAYER.NAME}, I hope your people will be successful.[if:convo_focused_happy]");
				StringHelpers.SetCharacterProperties("PLAYER", CharacterObject.PlayerCharacter, textObject);
				return textObject;
			}
		}

		protected override TextObject AlternativeSolutionStartLog
		{
			get
			{
				TextObject textObject = new TextObject("{=s5qs0bPs}{ISSUE_GIVER.LINK}, the {?ISSUE_GIVER.GENDER}lady{?}lord{\\?} of {QUEST_SETTLEMENT}, has told you about a spy that hides as a tournament attendee. You are asked to expose the spy and take care of him. You asked {COMPANION.LINK} to take {NEEDED_MEN_COUNT} of your best men to go and take care of it. They should report back to you in {ALTERNATIVE_SOLUTION_DURATION} days.");
				StringHelpers.SetCharacterProperties("ISSUE_GIVER", base.IssueOwner.CharacterObject, textObject);
				StringHelpers.SetCharacterProperties("COMPANION", base.AlternativeSolutionHero.CharacterObject, textObject);
				textObject.SetTextVariable("QUEST_SETTLEMENT", _selectedSettlement.EncyclopediaLinkWithName);
				textObject.SetTextVariable("ALTERNATIVE_SOLUTION_DURATION", GetTotalAlternativeSolutionDurationInDays());
				textObject.SetTextVariable("NEEDED_MEN_COUNT", AlternativeSolutionSentTroops.TotalManCount - 1);
				return textObject;
			}
		}

		public TheSpyPartyIssue(Hero issueOwner, Settlement selectedSettlement)
			: base(issueOwner, CampaignTime.DaysFromNow(5f))
		{
			_selectedSettlement = selectedSettlement;
		}

		protected override float GetIssueEffectAmountInternal(IssueEffect issueEffect)
		{
			if (issueEffect == DefaultIssueEffects.SettlementSecurity)
			{
				return -2f;
			}
			if (issueEffect == DefaultIssueEffects.SettlementLoyalty)
			{
				return -0.5f;
			}
			if (issueEffect == DefaultIssueEffects.ClanInfluence)
			{
				return -0.2f;
			}
			return 0f;
		}

		public override (SkillObject, int) GetAlternativeSolutionSkill(Hero hero)
		{
			return ((hero.GetSkillValue(DefaultSkills.Charm) >= hero.GetSkillValue(DefaultSkills.Roguery)) ? DefaultSkills.Charm : DefaultSkills.Roguery, 150);
		}

		public override bool AlternativeSolutionCondition(out TextObject explanation)
		{
			explanation = TextObject.Empty;
			return QuestHelper.CheckRosterForAlternativeSolution(MobileParty.MainParty.MemberRoster, GetTotalAlternativeSolutionNeededMenCount(), ref explanation, 2);
		}

		public override bool IsTroopTypeNeededByAlternativeSolution(CharacterObject character)
		{
			return character.Tier >= 2;
		}

		public override bool DoTroopsSatisfyAlternativeSolution(TroopRoster troopRoster, out TextObject explanation)
		{
			explanation = TextObject.Empty;
			return QuestHelper.CheckRosterForAlternativeSolution(troopRoster, GetTotalAlternativeSolutionNeededMenCount(), ref explanation, 2);
		}

		protected override void AlternativeSolutionEndWithSuccessConsequence()
		{
			GainRenownAction.Apply(Hero.MainHero, 1f);
			RelationshipChangeWithIssueOwner = 5;
			_selectedSettlement.Town.Prosperity += 5f;
		}

		protected override void AlternativeSolutionEndWithFailureConsequence()
		{
			RelationshipChangeWithIssueOwner = -5;
			base.IssueOwner.AddPower(-5f);
			_selectedSettlement.Town.Security -= 10f;
			_selectedSettlement.Town.Loyalty -= 10f;
		}

		protected override void OnGameLoad()
		{
		}

		protected override void HourlyTick()
		{
		}

		protected override QuestBase GenerateIssueQuest(string questId)
		{
			return new TheSpyPartyIssueQuest(questId, base.IssueOwner, CampaignTime.DaysFromNow(16f), RewardGold, _selectedSettlement, base.IssueDifficultyMultiplier);
		}

		public override IssueFrequency GetFrequency()
		{
			return IssueFrequency.Rare;
		}

		protected override bool CanPlayerTakeQuestConditions(Hero issueGiver, out PreconditionFlags flag, out Hero relationHero, out SkillObject skill)
		{
			flag = PreconditionFlags.None;
			relationHero = null;
			skill = null;
			if (issueGiver.GetRelationWithPlayer() < -10f)
			{
				flag |= PreconditionFlags.Relation;
				relationHero = issueGiver;
			}
			if (issueGiver.MapFaction.IsAtWarWith(Hero.MainHero.MapFaction))
			{
				flag |= PreconditionFlags.AtWar;
			}
			return flag == PreconditionFlags.None;
		}

		public override bool IssueStayAliveConditions()
		{
			if (base.IssueOwner.IsAlive && _selectedSettlement.OwnerClan == base.IssueOwner.Clan)
			{
				return base.IssueOwner.Clan != Clan.PlayerClan;
			}
			return false;
		}

		protected override void CompleteIssueWithTimedOutConsequences()
		{
		}

		internal static void AutoGeneratedStaticCollectObjectsTheSpyPartyIssue(object o, List<object> collectedObjects)
		{
			((TheSpyPartyIssue)o).AutoGeneratedInstanceCollectObjects(collectedObjects);
		}

		protected override void AutoGeneratedInstanceCollectObjects(List<object> collectedObjects)
		{
			base.AutoGeneratedInstanceCollectObjects(collectedObjects);
			collectedObjects.Add(_selectedSettlement);
		}

		internal static object AutoGeneratedGetMemberValue_selectedSettlement(object o)
		{
			return ((TheSpyPartyIssue)o)._selectedSettlement;
		}
	}

	public class TheSpyPartyIssueQuest : QuestBase
	{
		public const float CustomAgentHealth = 225f;

		[SaveableField(10)]
		private Settlement _selectedSettlement;

		[SaveableField(20)]
		private SuspectNpc _selectedSpy;

		private MBList<SuspectNpc> _suspectList;

		private List<Agent> _alreadySpokenAgents;

		[SaveableField(30)]
		private bool _playerLearnedHasHair;

		[SaveableField(40)]
		private bool _playerLearnedHasNoMarkings;

		[SaveableField(50)]
		private bool _playerLearnedHasBigSword;

		[SaveableField(60)]
		private bool _playerLearnedHasBeard;

		private bool _playerWonTheFight;

		private bool _addSpyNpcsToSettlement;

		private bool _startFightWithSpy;

		private bool _checkForBattleResult;

		private bool _playerManagedToFindSpy;

		private float _giveClueChange;

		private CharacterObject _duelCharacter;

		[SaveableField(70)]
		private float _issueDifficultyMultiplier;

		[SaveableField(80)]
		private string _currentDifficultySuffix;

		public override bool IsRemainingTimeHidden => false;

		public override TextObject Title => new TextObject("{=SJHtVaNa}The Spy Among Us");

		private TextObject _questStartedLog
		{
			get
			{
				TextObject textObject = new TextObject("{=94WRYoQp}{?QUEST_GIVER.GENDER}Lady{?}Lord{\\?} {QUEST_GIVER.LINK} from {QUEST_SETTLEMENT}, has told you about rumors of a spy disguised amongst the tournament attendees. You agreed to take care of the situation by yourself. {QUEST_GIVER.LINK} believes that the spy is posing as an tournament attendee in the city of {QUEST_SETTLEMENT}.");
				StringHelpers.SetCharacterProperties("QUEST_GIVER", base.QuestGiver.CharacterObject, textObject);
				textObject.SetTextVariable("QUEST_SETTLEMENT", _selectedSettlement.EncyclopediaLinkWithName);
				return textObject;
			}
		}

		private TextObject _questSuccessQuestLog
		{
			get
			{
				TextObject textObject = new TextObject("{=YIxpNP4k}You received a message from {QUEST_GIVER.LINK}. \"Thank you for killing the spy.[ib:hip][if:convo_grateful] Please accept these {REWARD_GOLD}{GOLD_ICON} denars with our gratitude.\"");
				StringHelpers.SetCharacterProperties("QUEST_GIVER", base.QuestGiver.CharacterObject, textObject);
				textObject.SetTextVariable("REWARD_GOLD", RewardGold);
				textObject.SetTextVariable("GOLD_ICON", "{=!}<img src=\"General\\Icons\\Coin@2x\" extend=\"8\">");
				return textObject;
			}
		}

		private TextObject _questFailedKilledAnotherQuestLog
		{
			get
			{
				TextObject textObject = new TextObject("{=tTKpOFRK}You won the duel but your opponent was innocent. {QUEST_GIVER.LINK} is disappointed.");
				StringHelpers.SetCharacterProperties("QUEST_GIVER", base.QuestGiver.CharacterObject, textObject);
				return textObject;
			}
		}

		private TextObject _playerFoundTheSpyButLostTheFight
		{
			get
			{
				TextObject textObject = new TextObject("{=hJ1SFkmq}You managed to find the spy but lost the duel. {QUEST_GIVER.LINK} is disappointed.");
				StringHelpers.SetCharacterProperties("QUEST_GIVER", base.QuestGiver.CharacterObject, textObject);
				return textObject;
			}
		}

		private TextObject _playerCouldNotFoundTheSpyAndLostTheFight
		{
			get
			{
				TextObject textObject = new TextObject("{=dOdp1aKA}You couldn't find the spy and dueled the wrong warrior. {QUEST_GIVER.LINK} is disappointed.");
				StringHelpers.SetCharacterProperties("QUEST_GIVER", base.QuestGiver.CharacterObject, textObject);
				return textObject;
			}
		}

		private TextObject _timedOutQuestLog
		{
			get
			{
				TextObject textObject = new TextObject("{=0dlDkkJV}You have failed to find the spy. {QUEST_GIVER.LINK} is disappointed.");
				StringHelpers.SetCharacterProperties("QUEST_GIVER", base.QuestGiver.CharacterObject, textObject);
				return textObject;
			}
		}

		private TextObject _questGiverLostOwnershipQuestLog
		{
			get
			{
				TextObject textObject = new TextObject("{=2OmrHVjp}{QUEST_GIVER.LINK} has lost the ownership of {QUEST_SETTLEMENT}. Your contract with {?QUEST_GIVER.GENDER}her{?}him{\\?} has canceled.");
				StringHelpers.SetCharacterProperties("QUEST_GIVER", base.QuestGiver.CharacterObject, textObject);
				textObject.SetTextVariable("QUEST_SETTLEMENT", _selectedSettlement.EncyclopediaLinkWithName);
				return textObject;
			}
		}

		private TextObject _warDeclaredQuestLog
		{
			get
			{
				TextObject textObject = new TextObject("{=cKz1cyuM}Your clan is now at war with {QUEST_GIVER_SETTLEMENT_FACTION}. Quest is canceled.");
				textObject.SetTextVariable("QUEST_GIVER_SETTLEMENT_FACTION", base.QuestGiver.MapFaction.Name);
				return textObject;
			}
		}

		private TextObject _playerDeclaredWarQuestLogText
		{
			get
			{
				TextObject textObject = new TextObject("{=bqeWVVEE}Your actions have started a war with {QUEST_GIVER.LINK}'s faction. {?QUEST_GIVER.GENDER}She{?}He{\\?} cancels your agreement and the quest is a failure.");
				StringHelpers.SetCharacterProperties("QUEST_GIVER", base.QuestGiver.CharacterObject, textObject);
				return textObject;
			}
		}

		public TheSpyPartyIssueQuest(string questId, Hero questGiver, CampaignTime duration, int rewardGold, Settlement selectedSettlement, float issueDifficultyMultiplier)
			: base(questId, questGiver, duration, rewardGold)
		{
			_selectedSettlement = selectedSettlement;
			_alreadySpokenAgents = new List<Agent>();
			_issueDifficultyMultiplier = issueDifficultyMultiplier;
			_giveClueChange = 0.1f;
			SetDialogs();
			InitializeQuestOnCreation();
			InitializeSuspectNpcs();
			_selectedSpy = _suspectList.GetRandomElement();
			if (!IsTracked(_selectedSettlement))
			{
				AddTrackedObject(_selectedSettlement);
			}
		}

		private void InitializeSuspectNpcs()
		{
			_suspectList = new MBList<SuspectNpc>();
			_currentDifficultySuffix = GetDifficultySuffix(_issueDifficultyMultiplier);
			_suspectList.Add(new SuspectNpc(MBObjectManager.Instance.GetObject<CharacterObject>("bold_contender_" + _currentDifficultySuffix), hasHair: false, hasBigSword: true, withoutMarkings: true, hasBeard: true));
			_suspectList.Add(new SuspectNpc(MBObjectManager.Instance.GetObject<CharacterObject>("confident_contender_" + _currentDifficultySuffix), hasHair: true, hasBigSword: false, withoutMarkings: true, hasBeard: true));
			_suspectList.Add(new SuspectNpc(MBObjectManager.Instance.GetObject<CharacterObject>("dignified_contender_" + _currentDifficultySuffix), hasHair: true, hasBigSword: true, withoutMarkings: false, hasBeard: true));
			_suspectList.Add(new SuspectNpc(MBObjectManager.Instance.GetObject<CharacterObject>("hardy_contender_" + _currentDifficultySuffix), hasHair: true, hasBigSword: true, withoutMarkings: true, hasBeard: false));
		}

		protected override void InitializeQuestOnGameLoad()
		{
			_alreadySpokenAgents = new List<Agent>();
			_giveClueChange = 0.1f;
			InitializeSuspectNpcs();
			SetDialogs();
			if (Settlement.CurrentSettlement != null && Settlement.CurrentSettlement == _selectedSettlement)
			{
				_addSpyNpcsToSettlement = true;
			}
		}

		protected override void HourlyTick()
		{
		}

		protected override void SetDialogs()
		{
			TextObject textObject = new TextObject("{=wql79Eta}Good! We understand the spy is going to {TARGET_SETTLEMENT}. If they're trying to gather information,[ib:aggressive2][if:convo_undecided_open] they'll be wandering around the market asking questions in the guise of making small talk. Just go around talking to the townsfolk, and you should be able to figure out who it is.");
			textObject.SetTextVariable("TARGET_SETTLEMENT", _selectedSettlement.EncyclopediaLinkWithName);
			TextObject textObject2 = new TextObject("{=aC0Fq6IE}Do not waste time, {PLAYER.NAME}. The spy probably won't linger any longer than he has to.[if:convo_thinking] Or she has to.");
			StringHelpers.SetCharacterProperties("PLAYER", CharacterObject.PlayerCharacter, textObject2);
			OfferDialogFlow = DialogFlow.CreateDialogFlow("issue_classic_quest_start").NpcLine(textObject).Condition(() => Hero.OneToOneConversationHero == base.QuestGiver)
				.Consequence(QuestAcceptedConsequences)
				.CloseDialog();
			DiscussDialogFlow = DialogFlow.CreateDialogFlow("quest_discuss").NpcLine(new TextObject("{=yLRfb5zb}Any news? Have you managed to find him yet?[if:convo_astonished]")).Condition(() => Hero.OneToOneConversationHero == base.QuestGiver)
				.BeginPlayerOptions()
				.PlayerOption(new TextObject("{=wErSpkjy}I'm still working on it."))
				.NpcLine(textObject2)
				.Consequence(LeaveEncounter)
				.CloseDialog()
				.PlayerOption(new TextObject("{=I8raOMRH}Sorry. No progress yet."))
				.NpcLine(new TextObject("{=ajSm2FEU}I know spies are hard to catch but I tasked this to you for a reason. [if:convo_stern]Do not let me down {PLAYER.NAME}."))
				.NpcLine(new TextObject("{=pW69nUp8}Finish this task before it is too late.[if:convo_stern]"))
				.Consequence(LeaveEncounter)
				.CloseDialog()
				.EndPlayerOptions()
				.CloseDialog();
			Campaign.Current.ConversationManager.AddDialogFlow(GetTownsPeopleDialogFlow(), this);
			Campaign.Current.ConversationManager.AddDialogFlow(GetNotablesDialogFlow(), this);
			Campaign.Current.ConversationManager.AddDialogFlow(GetTradersDialogFlow(), this);
			Campaign.Current.ConversationManager.AddDialogFlow(GetSuspectsDialogFlow(), this);
		}

		private void LeaveEncounter()
		{
			if (PlayerEncounter.Current != null)
			{
				PlayerEncounter.LeaveEncounter = true;
			}
		}

		private void QuestAcceptedConsequences()
		{
			StartQuest();
			AddLog(_questStartedLog);
			if (Settlement.CurrentSettlement != null && Settlement.CurrentSettlement == _selectedSettlement)
			{
				_addSpyNpcsToSettlement = true;
			}
		}

		private DialogFlow GetSuspectsDialogFlow()
		{
			return DialogFlow.CreateDialogFlow("start", 125).NpcLine(new TextObject("{=IqhGJ8Dy}Hello there friend. Are you here for the tournament.[ib:confident3][if:convo_relaxed_happy]")).Condition(() => _suspectList.Any((SuspectNpc x) => x.CharacterObject == CharacterObject.OneToOneConversationCharacter))
				.BeginPlayerOptions()
				.PlayerOption(new TextObject("{=SRa9NyP1}No, my friend. I am on a hunt."))
				.NpcLine(new TextObject("{=gYCSwLB2}Eh, what do you mean by that?[ib:closed][if:convo_confused_normal]"))
				.BeginPlayerOptions()
				.PlayerOption(new TextObject("{=oddzOnad}I'm hunting a spy. And now I have found him."))
				.NpcLine(new TextObject("{=MU8nbzwJ}You have nothing on me. If you try to take me anywhere I'll kill you, and it will be in self-defense.[if:convo_grave]"))
				.PlayerLine(new TextObject("{=WDdlPUHw}Not if it's a duel. I challenge you. No true tournament fighter would refuse."))
				.NpcLine(new TextObject("{=Ll8q45h5}Hmf... Very well. I shall wipe out this insult with your blood.[ib:warrior][if:convo_furious]"))
				.Consequence(delegate
				{
					Campaign.Current.ConversationManager.ConversationEndOneShot += StartFightWithSpy;
				})
				.CloseDialog()
				.PlayerOption(new TextObject("{=O5PDH9Bc}Nothing, nothing. Go on your way."))
				.CloseDialog()
				.EndPlayerOptions()
				.PlayerOption(new TextObject("{=O7j0uzcH}I should be on my way."))
				.CloseDialog()
				.EndPlayerOptions();
		}

		private void StartFightWithSpy()
		{
			_playerManagedToFindSpy = _selectedSpy.CharacterObject == CharacterObject.OneToOneConversationCharacter;
			_duelCharacter = CharacterObject.OneToOneConversationCharacter;
			_startFightWithSpy = true;
			Campaign.Current.GameMenuManager.NextLocation = LocationComplex.Current.GetLocationWithId("arena");
			Mission.Current.EndMission();
		}

		private DialogFlow GetNotablesDialogFlow()
		{
			TextObject textObject = new TextObject("{=0RTwaPBJ}I speak to many people. Of course, as I am loyal to {QUEST_GIVER.NAME}, [if:convo_pondering]I am always on the lookout for spies. But I've seen no one like this.");
			StringHelpers.SetCharacterProperties("QUEST_GIVER", base.QuestGiver.CharacterObject, textObject);
			return DialogFlow.CreateDialogFlow("hero_main_options", 125).BeginPlayerOptions().PlayerOption(new TextObject("{=xPTxkzVM}I am looking for a spy. Have you seen any warriors in the tournament wandering about, asking too many suspicious questions?"))
				.Condition(() => Settlement.CurrentSettlement == _selectedSettlement && Hero.OneToOneConversationHero.IsNotable)
				.NpcLine(textObject)
				.CloseDialog()
				.EndPlayerOptions();
		}

		private DialogFlow GetTradersDialogFlow()
		{
			return DialogFlow.CreateDialogFlow("weaponsmith_talk_player", 125).BeginPlayerOptions().PlayerOption(new TextObject("{=SHwlcdp3}I ask you because you are a trader here. Have you seen one of the warriors in the tournament walking around here, asking people a lot of suspicious questions?"))
				.Condition(() => Settlement.CurrentSettlement == _selectedSettlement && (CharacterObject.OneToOneConversationCharacter.Occupation == Occupation.HorseTrader || CharacterObject.OneToOneConversationCharacter.Occupation == Occupation.GoodsTrader || CharacterObject.OneToOneConversationCharacter.Occupation == Occupation.Blacksmith || CharacterObject.OneToOneConversationCharacter.Occupation == Occupation.Weaponsmith))
				.NpcLine(new TextObject("{=ocoHNhNk}Hmm... I keep pretty busy with my own trade. I haven't heard anything like that.[if:convo_pondering]"))
				.CloseDialog()
				.EndPlayerOptions();
		}

		private DialogFlow GetTownsPeopleDialogFlow()
		{
			TextObject playerOption1 = new TextObject("{=A2oos2Uo}Listen to me. I'm on assignment from {QUEST_GIVER.NAME}. Have any strangers been around here, asking odd questions about the garrison?");
			StringHelpers.SetCharacterProperties("QUEST_GIVER", base.QuestGiver.CharacterObject, playerOption1);
			TextObject playerOption2 = new TextObject("{=RXhBl8e1}Act normal. Have any of the participants in the tournament come round, asking very odd questions?");
			TextObject playerOption3 = new TextObject("{=HF2GIpbI}Listen to me. Have any of the tournament participants spent long hours in the market and tavern? More than usual?");
			float dontGiveClueResponse = 0f;
			bool giveClue = false;
			return DialogFlow.CreateDialogFlow("town_or_village_player", 125).BeginPlayerOptions().PlayerOption(new TextObject("{=GtgGnMe1}{PLAYER_OPTION}"))
				.Condition(delegate
				{
					if (Settlement.CurrentSettlement == _selectedSettlement)
					{
						float randomFloat = MBRandom.RandomFloat;
						dontGiveClueResponse = MBRandom.RandomFloat;
						if (randomFloat < 0.33f)
						{
							MBTextManager.SetTextVariable("PLAYER_OPTION", playerOption1);
						}
						else if (randomFloat >= 0.33f && randomFloat <= 0.66f)
						{
							MBTextManager.SetTextVariable("PLAYER_OPTION", playerOption2);
						}
						else
						{
							MBTextManager.SetTextVariable("PLAYER_OPTION", playerOption3);
						}
						return true;
					}
					return false;
				})
				.Consequence(delegate
				{
					giveClue = _giveClueChange >= MBRandom.RandomFloat;
					Campaign.Current.ConversationManager.ConversationEndOneShot += AddAgentToAlreadySpokenList;
				})
				.BeginNpcOptions()
				.NpcOption(new TextObject("{=8gmne3b9}Not to me {?PLAYER.GENDER}madam{?}sir{\\?}, no. I did overhear someone talking to another merchant about such things. I remember him because he had this nasty looking sword by his side.[if:convo_disbelief]"), () => giveClue && _selectedSpy.HasBigSword && !_playerLearnedHasBigSword && CommonCondition())
				.PlayerLine(new TextObject("{=VP6s1YFW}Many contenders have swords on their backs. Still this information might prove useful."))
				.Consequence(PlayerLearnedSpyHasSword)
				.CloseDialog()
				.NpcOption(new TextObject("{=gHnMYU9n}Why yes... At the tavern last night... Cornered a drunk and kept pressing him for information about the gatehouse. Had a beard, that one did.[if:convo_pondering]"), () => giveClue && _selectedSpy.HasBeard && !_playerLearnedHasBeard && CommonCondition())
				.PlayerLine(new TextObject("{=QaAzicqA}Many men have beards. Still, that is something."))
				.Consequence(PlayerLearnedSpyHasBeard)
				.CloseDialog()
				.NpcOption(new TextObject("{=DUVqJifX}Yeah. I've seen one like that around the arena, asking all matter of outlandish questions. Middle-aged, normal head of hair, that's really all I can remember though.[if:convo_thinking]"), () => giveClue && _selectedSpy.HasHair && !_playerLearnedHasHair && CommonCondition())
				.PlayerLine(new TextObject("{=JjtmptiD}More men have hair than not, but this is another tile in the mosaic."))
				.Consequence(PlayerLearnedSpyHasHair)
				.CloseDialog()
				.NpcOption(new TextObject("{=tXpmCzoZ}Well, there was one warrior. A handsome young lad. Didn't have any of those scars that some fighters pick up in battle, nor any of those marks or tattoos or whatever that [if:convo_pondering]some of the hard cases like to show off."), () => giveClue && _selectedSpy.WithoutMarkings && !_playerLearnedHasNoMarkings && CommonCondition())
				.PlayerLine(new TextObject("{=ZCbQvqqv}A face without scars and markings is usual for farmers and merchants but less so for warriors. This might be useful."))
				.Consequence(PlayerLearnedSpyHasNoMarkings)
				.CloseDialog()
				.NpcOption(new TextObject("{=sfxfiWxl}{?PLAYER.GENDER}Madam{?}Sir{\\?}, people gossip. Everyone around here knows you've been asking those questions. Your quarry is going to slip away if you don't move quickly."), () => dontGiveClueResponse <= 0.2f)
				.PlayerLine(new TextObject("{=04gFKwY1}Well, if you see anyone like that, let me know."))
				.CloseDialog()
				.NpcOption(new TextObject("{=VWaNqkqJ}Can't say I've seen anyone around here like that, {?PLAYER.GENDER}madam{?}sir{\\?}."), () => dontGiveClueResponse > 0.2f && dontGiveClueResponse <= 0.4f)
				.PlayerLine(new TextObject("{=QbzsgawM}Okay, just keep your eyes open."))
				.CloseDialog()
				.NpcOption(new TextObject("{=ff5XEKPB}Afraid I can't recall anyone like that, {?PLAYER.GENDER}madam{?}sir{\\?}."), () => dontGiveClueResponse > 0.4f && dontGiveClueResponse <= 0.6f)
				.PlayerLine(new TextObject("{=ArseaKsm}Very well. Thanks for your time."))
				.CloseDialog()
				.NpcOption(new TextObject("{=C6EOT3yY}No, sorry. Haven't seen anything like that."), () => dontGiveClueResponse > 0.6f && dontGiveClueResponse <= 0.8f)
				.PlayerLine(new TextObject("{=3UX334MB}Hmm.. Very well. Sorry for interrupting."))
				.CloseDialog()
				.NpcOption(new TextObject("{=9DDWjL9Y}Hmm... Maybe, but I can't remember who. I didn't think it suspicious."), () => dontGiveClueResponse > 0.8f)
				.PlayerLine(new TextObject("{=QbzsgawM}Okay, just keep your eyes open."))
				.CloseDialog()
				.EndNpcOptions()
				.EndPlayerOptions();
		}

		private void AddAgentToAlreadySpokenList()
		{
			_giveClueChange += 0.15f;
			_alreadySpokenAgents.Add((Agent)MissionConversationLogic.Current.ConversationManager.ConversationAgents[0]);
		}

		private bool CommonCondition()
		{
			if (Settlement.CurrentSettlement == _selectedSettlement && !_alreadySpokenAgents.Contains((Agent)MissionConversationLogic.Current.ConversationManager.ConversationAgents[0]))
			{
				return CharacterObject.OneToOneConversationCharacter.Occupation == Occupation.Townsfolk;
			}
			return false;
		}

		private void CheckIfPlayerLearnedEverything()
		{
			int num = 0;
			num = ((!_playerLearnedHasBeard) ? num : (++num));
			num = ((!_playerLearnedHasBigSword) ? num : (++num));
			num = ((!_playerLearnedHasHair) ? num : (++num));
			num = ((!_playerLearnedHasNoMarkings) ? num : (++num));
			if (num >= 3)
			{
				TextObject text = new TextObject("{=2LW2jWuG}You should now have enough evidence to identify the spy. You might be able to find the tournament participants hanging out in the alleys with local thugs. Find and speak with them.");
				AddLog(text);
			}
		}

		private void PlayerLearnedSpyHasSword()
		{
			_giveClueChange = 0f;
			_playerLearnedHasBigSword = true;
			AddLog(new TextObject("{=awYMellZ}The spy is known to carry a sword."));
			_alreadySpokenAgents.Add(MissionConversationLogic.Current.ConversationAgent);
			CheckIfPlayerLearnedEverything();
		}

		private void PlayerLearnedSpyHasBeard()
		{
			_giveClueChange = 0f;
			_playerLearnedHasBeard = true;
			AddLog(new TextObject("{=5om6Wv1n}After questioning some folk in town, you learned that the spy has a beard."));
			_alreadySpokenAgents.Add(MissionConversationLogic.Current.ConversationAgent);
			CheckIfPlayerLearnedEverything();
		}

		private void PlayerLearnedSpyHasHair()
		{
			_giveClueChange = 0f;
			_playerLearnedHasHair = true;
			AddLog(new TextObject("{=PLgOm8tV}The townsfolk told you that the spy is not bald."));
			_alreadySpokenAgents.Add(MissionConversationLogic.Current.ConversationAgent);
			CheckIfPlayerLearnedEverything();
		}

		private void PlayerLearnedSpyHasNoMarkings()
		{
			_giveClueChange = 0f;
			_playerLearnedHasNoMarkings = true;
			AddLog(new TextObject("{=1ieLd5qq}The townsfolk told you that the spy has no distinctive scars or other facial markings."));
			_alreadySpokenAgents.Add(MissionConversationLogic.Current.ConversationAgent);
			CheckIfPlayerLearnedEverything();
		}

		protected override void RegisterEvents()
		{
			CampaignEvents.SettlementEntered.AddNonSerializedListener(this, OnSettlementEntered);
			CampaignEvents.OnSettlementLeftEvent.AddNonSerializedListener(this, OnSettlementLeft);
			CampaignEvents.AfterMissionStarted.AddNonSerializedListener(this, OnMissionStarted);
			CampaignEvents.OnSettlementOwnerChangedEvent.AddNonSerializedListener(this, OnSettlementOwnerChanged);
			CampaignEvents.WarDeclared.AddNonSerializedListener(this, OnWarDeclared);
			CampaignEvents.ClanChangedKingdom.AddNonSerializedListener(this, OnClanChangedKingdom);
			CampaignEvents.BeforeGameMenuOpenedEvent.AddNonSerializedListener(this, BeforeGameMenuOpenedEvent);
			CampaignEvents.MapEventStarted.AddNonSerializedListener(this, OnMapEventStarted);
		}

		private void OnMapEventStarted(MapEvent mapEvent, PartyBase attackerParty, PartyBase defenderParty)
		{
			if (QuestHelper.CheckMinorMajorCoercion(this, mapEvent, attackerParty))
			{
				QuestHelper.ApplyGenericMinorMajorCoercionConsequences(this, mapEvent);
			}
		}

		private void BeforeGameMenuOpenedEvent(MenuCallbackArgs args)
		{
			if (Settlement.CurrentSettlement != _selectedSettlement || !(args.MenuContext.GameMenu.StringId == "town"))
			{
				return;
			}
			if (_startFightWithSpy && Campaign.Current.GameMenuManager.NextLocation == LocationComplex.Current.GetLocationWithId("arena") && GameStateManager.Current.ActiveState is MapState)
			{
				_startFightWithSpy = false;
				CampaignMission.OpenArenaDuelMission(LocationComplex.Current.GetLocationWithId("arena").GetSceneName(_selectedSettlement.Town.GetWallLevel()), LocationComplex.Current.GetLocationWithId("arena"), _duelCharacter, requireCivilianEquipment: false, spawnBothSidesWithHorse: false, OnFightEnd, 225f);
				Campaign.Current.GameMenuManager.NextLocation = null;
			}
			if (!_checkForBattleResult)
			{
				return;
			}
			if (_playerWonTheFight)
			{
				if (_playerManagedToFindSpy)
				{
					PlayerFoundTheSpyAndKilledHim();
				}
				else
				{
					PlayerCouldNotFoundTheSpyAndKilledAnotherSuspect();
				}
			}
			else if (_playerManagedToFindSpy)
			{
				PlayerFoundTheSpyButLostTheFight();
			}
			else
			{
				PlayerCouldNotFoundTheSpyAndLostTheFight();
			}
		}

		private void PlayerFoundTheSpyAndKilledHim()
		{
			AddLog(_questSuccessQuestLog);
			GainRenownAction.Apply(Hero.MainHero, 1f);
			GiveGoldAction.ApplyBetweenCharacters(null, Hero.MainHero, RewardGold);
			RelationshipChangeWithQuestGiver = 5;
			_selectedSettlement.Town.Prosperity += 5f;
			CompleteQuestWithSuccess();
		}

		private void PlayerCouldNotFoundTheSpyAndKilledAnotherSuspect()
		{
			AddLog(_questFailedKilledAnotherQuestLog);
			ChangeCrimeRatingAction.Apply(base.QuestGiver.MapFaction, 10f);
			RelationshipChangeWithQuestGiver = -5;
			_selectedSettlement.Town.Security -= 10f;
			_selectedSettlement.Town.Loyalty -= 10f;
			CompleteQuestWithFail();
		}

		private void PlayerFoundTheSpyButLostTheFight()
		{
			AddLog(_playerFoundTheSpyButLostTheFight);
			RelationshipChangeWithQuestGiver = -5;
			_selectedSettlement.Town.Security -= 10f;
			_selectedSettlement.Town.Loyalty -= 10f;
			CompleteQuestWithFail();
		}

		private void PlayerCouldNotFoundTheSpyAndLostTheFight()
		{
			AddLog(_playerCouldNotFoundTheSpyAndLostTheFight);
			RelationshipChangeWithQuestGiver = -5;
			_selectedSettlement.Town.Security -= 10f;
			_selectedSettlement.Town.Loyalty -= 10f;
			CompleteQuestWithFail();
		}

		private void OnFightEnd(CharacterObject winnerCharacterObject)
		{
			_checkForBattleResult = true;
			_playerWonTheFight = winnerCharacterObject == CharacterObject.PlayerCharacter;
		}

		private void OnClanChangedKingdom(Clan clan, Kingdom oldKingdom, Kingdom newKingdom, ChangeKingdomAction.ChangeKingdomActionDetail detail, bool showNotification = true)
		{
			if (base.QuestGiver.MapFaction.IsAtWarWith(Hero.MainHero.MapFaction))
			{
				CompleteQuestWithCancel(_warDeclaredQuestLog);
			}
		}

		private void OnWarDeclared(IFaction faction1, IFaction faction2, DeclareWarAction.DeclareWarDetail detail)
		{
			QuestHelper.CheckWarDeclarationAndFailOrCancelTheQuest(this, faction1, faction2, detail, _playerDeclaredWarQuestLogText, _warDeclaredQuestLog);
		}

		private void OnSettlementOwnerChanged(Settlement settlement, bool openToClaim, Hero newOwner, Hero oldOwner, Hero capturerHero, ChangeOwnerOfSettlementAction.ChangeOwnerOfSettlementDetail detail)
		{
			if (settlement == _selectedSettlement && oldOwner.Clan == base.QuestGiver.Clan)
			{
				AddLog(_questGiverLostOwnershipQuestLog);
				CompleteQuestWithCancel();
			}
		}

		private void OnSettlementEntered(MobileParty party, Settlement settlement, Hero hero)
		{
			if (party != null && party.IsMainParty && settlement == _selectedSettlement && hero == Hero.MainHero)
			{
				_addSpyNpcsToSettlement = true;
			}
		}

		public override GameMenuOption.IssueQuestFlags IsLocationTrackedByQuest(Location location)
		{
			if (PlayerEncounter.LocationEncounter.Settlement == _selectedSettlement && location.StringId == "center")
			{
				return GameMenuOption.IssueQuestFlags.ActiveIssue;
			}
			return GameMenuOption.IssueQuestFlags.None;
		}

		private void OnSettlementLeft(MobileParty party, Settlement settlement)
		{
			if (party.IsMainParty && settlement == _selectedSettlement)
			{
				_addSpyNpcsToSettlement = false;
			}
		}

		private void OnMissionStarted(IMission mission)
		{
			if (_addSpyNpcsToSettlement)
			{
				Location locationWithId = Settlement.CurrentSettlement.LocationComplex.GetLocationWithId("center");
				if (locationWithId != null)
				{
					locationWithId.AddLocationCharacters(CreateBoldSpyLocationCharacter, Settlement.CurrentSettlement.Culture, LocationCharacter.CharacterRelations.Neutral, 1);
					locationWithId.AddLocationCharacters(CreateConfidentSpyLocationCharacter, Settlement.CurrentSettlement.Culture, LocationCharacter.CharacterRelations.Neutral, 1);
					locationWithId.AddLocationCharacters(CreateDignifiedSpyLocationCharacter, Settlement.CurrentSettlement.Culture, LocationCharacter.CharacterRelations.Neutral, 1);
					locationWithId.AddLocationCharacters(CreateHardySpyLocationCharacters, Settlement.CurrentSettlement.Culture, LocationCharacter.CharacterRelations.Neutral, 1);
				}
			}
		}

		private LocationCharacter CreateBoldSpyLocationCharacter(CultureObject culture, LocationCharacter.CharacterRelations relation)
		{
			CharacterObject @object = MBObjectManager.Instance.GetObject<CharacterObject>("bold_contender_" + _currentDifficultySuffix);
			Monster monsterWithSuffix = TaleWorlds.Core.FaceGen.GetMonsterWithSuffix(@object.Race, "_settlement");
			Tuple<string, Monster> tuple = new Tuple<string, Monster>(ActionSetCode.GenerateActionSetNameWithSuffix(monsterWithSuffix, @object.IsFemale, "_villain"), monsterWithSuffix);
			return new LocationCharacter(new AgentData(new SimpleAgentOrigin(@object)).Monster(tuple.Item2), SandBoxManager.Instance.AgentBehaviorManager.AddFixedCharacterBehaviors, "alley_1", fixedLocation: true, relation, tuple.Item1, useCivilianEquipment: true, isFixedCharacter: false, null, isHidden: false, isVisualTracked: true, overrideBodyProperties: false);
		}

		private LocationCharacter CreateConfidentSpyLocationCharacter(CultureObject culture, LocationCharacter.CharacterRelations relation)
		{
			CharacterObject @object = MBObjectManager.Instance.GetObject<CharacterObject>("confident_contender_" + _currentDifficultySuffix);
			Monster monsterWithSuffix = TaleWorlds.Core.FaceGen.GetMonsterWithSuffix(@object.Race, "_settlement");
			Tuple<string, Monster> tuple = new Tuple<string, Monster>(ActionSetCode.GenerateActionSetNameWithSuffix(monsterWithSuffix, @object.IsFemale, "_villain"), monsterWithSuffix);
			return new LocationCharacter(new AgentData(new SimpleAgentOrigin(@object)).Monster(tuple.Item2), SandBoxManager.Instance.AgentBehaviorManager.AddFixedCharacterBehaviors, "alley_3", fixedLocation: true, relation, tuple.Item1, useCivilianEquipment: true, isFixedCharacter: false, null, isHidden: false, isVisualTracked: true, overrideBodyProperties: false);
		}

		private LocationCharacter CreateDignifiedSpyLocationCharacter(CultureObject culture, LocationCharacter.CharacterRelations relation)
		{
			CharacterObject @object = MBObjectManager.Instance.GetObject<CharacterObject>("dignified_contender_" + _currentDifficultySuffix);
			Monster monsterWithSuffix = TaleWorlds.Core.FaceGen.GetMonsterWithSuffix(@object.Race, "_settlement");
			Tuple<string, Monster> tuple = new Tuple<string, Monster>(ActionSetCode.GenerateActionSetNameWithSuffix(monsterWithSuffix, @object.IsFemale, "_villain"), monsterWithSuffix);
			return new LocationCharacter(new AgentData(new SimpleAgentOrigin(@object)).Monster(tuple.Item2), SandBoxManager.Instance.AgentBehaviorManager.AddFixedCharacterBehaviors, "alley_3", fixedLocation: true, relation, tuple.Item1, useCivilianEquipment: true, isFixedCharacter: false, null, isHidden: false, isVisualTracked: true, overrideBodyProperties: false);
		}

		private LocationCharacter CreateHardySpyLocationCharacters(CultureObject culture, LocationCharacter.CharacterRelations relation)
		{
			CharacterObject @object = MBObjectManager.Instance.GetObject<CharacterObject>("hardy_contender_" + _currentDifficultySuffix);
			Monster monsterWithSuffix = TaleWorlds.Core.FaceGen.GetMonsterWithSuffix(@object.Race, "_settlement");
			Tuple<string, Monster> tuple = new Tuple<string, Monster>(ActionSetCode.GenerateActionSetNameWithSuffix(monsterWithSuffix, @object.IsFemale, "_villain"), monsterWithSuffix);
			return new LocationCharacter(new AgentData(new SimpleAgentOrigin(@object)).Monster(tuple.Item2), SandBoxManager.Instance.AgentBehaviorManager.AddFixedCharacterBehaviors, "alley_2", fixedLocation: true, relation, tuple.Item1, useCivilianEquipment: true, isFixedCharacter: false, null, isHidden: false, isVisualTracked: true, overrideBodyProperties: false);
		}

		protected override void OnTimedOut()
		{
			AddLog(_timedOutQuestLog);
			base.QuestGiver.AddPower(-5f);
			RelationshipChangeWithQuestGiver = -5;
			_selectedSettlement.Town.Security -= 10f;
			_selectedSettlement.Town.Loyalty -= 10f;
		}

		internal static void AutoGeneratedStaticCollectObjectsTheSpyPartyIssueQuest(object o, List<object> collectedObjects)
		{
			((TheSpyPartyIssueQuest)o).AutoGeneratedInstanceCollectObjects(collectedObjects);
		}

		protected override void AutoGeneratedInstanceCollectObjects(List<object> collectedObjects)
		{
			base.AutoGeneratedInstanceCollectObjects(collectedObjects);
			collectedObjects.Add(_selectedSettlement);
			SuspectNpc.AutoGeneratedStaticCollectObjectsSuspectNpc(_selectedSpy, collectedObjects);
		}

		internal static object AutoGeneratedGetMemberValue_selectedSettlement(object o)
		{
			return ((TheSpyPartyIssueQuest)o)._selectedSettlement;
		}

		internal static object AutoGeneratedGetMemberValue_selectedSpy(object o)
		{
			return ((TheSpyPartyIssueQuest)o)._selectedSpy;
		}

		internal static object AutoGeneratedGetMemberValue_playerLearnedHasHair(object o)
		{
			return ((TheSpyPartyIssueQuest)o)._playerLearnedHasHair;
		}

		internal static object AutoGeneratedGetMemberValue_playerLearnedHasNoMarkings(object o)
		{
			return ((TheSpyPartyIssueQuest)o)._playerLearnedHasNoMarkings;
		}

		internal static object AutoGeneratedGetMemberValue_playerLearnedHasBigSword(object o)
		{
			return ((TheSpyPartyIssueQuest)o)._playerLearnedHasBigSword;
		}

		internal static object AutoGeneratedGetMemberValue_playerLearnedHasBeard(object o)
		{
			return ((TheSpyPartyIssueQuest)o)._playerLearnedHasBeard;
		}

		internal static object AutoGeneratedGetMemberValue_issueDifficultyMultiplier(object o)
		{
			return ((TheSpyPartyIssueQuest)o)._issueDifficultyMultiplier;
		}

		internal static object AutoGeneratedGetMemberValue_currentDifficultySuffix(object o)
		{
			return ((TheSpyPartyIssueQuest)o)._currentDifficultySuffix;
		}
	}

	private const IssueBase.IssueFrequency TheSpyPartyIssueFrequency = IssueBase.IssueFrequency.Rare;

	private const int IssueDuration = 5;

	public override void RegisterEvents()
	{
		CampaignEvents.OnCheckForIssueEvent.AddNonSerializedListener(this, OnCheckForIssue);
	}

	public void OnCheckForIssue(Hero hero)
	{
		if (ConditionsHold(hero, out var selectedSettlement))
		{
			Campaign.Current.IssueManager.AddPotentialIssueData(hero, new PotentialIssueData(OnStartIssue, typeof(TheSpyPartyIssue), IssueBase.IssueFrequency.Rare, selectedSettlement));
		}
		else
		{
			Campaign.Current.IssueManager.AddPotentialIssueData(hero, new PotentialIssueData(typeof(TheSpyPartyIssue), IssueBase.IssueFrequency.Rare));
		}
	}

	private bool ConditionsHold(Hero issueGiver, out Settlement selectedSettlement)
	{
		selectedSettlement = null;
		int num;
		if (issueGiver.IsLord && issueGiver.Clan != Clan.PlayerClan && issueGiver.Clan.Settlements.Any((Settlement x) => x.IsTown))
		{
			selectedSettlement = issueGiver.Clan.Settlements.GetRandomElementWithPredicate((Settlement x) => x.IsTown);
			string difficultySuffix = GetDifficultySuffix(Campaign.Current.Models.IssueModel.GetIssueDifficultyMultiplier());
			if (MBObjectManager.Instance.GetObject<CharacterObject>("bold_contender_" + difficultySuffix) != null && MBObjectManager.Instance.GetObject<CharacterObject>("confident_contender_" + difficultySuffix) != null && MBObjectManager.Instance.GetObject<CharacterObject>("dignified_contender_" + difficultySuffix) != null)
			{
				num = ((MBObjectManager.Instance.GetObject<CharacterObject>("hardy_contender_" + difficultySuffix) != null) ? 1 : 0);
				if (num != 0)
				{
					goto IL_010b;
				}
			}
			else
			{
				num = 0;
			}
			CampaignEventDispatcher.Instance.RemoveListeners(this);
			goto IL_010b;
		}
		return false;
		IL_010b:
		return (byte)num != 0;
	}

	private static string GetDifficultySuffix(float difficulty)
	{
		if (difficulty <= 0.25f)
		{
			return "easy";
		}
		if (difficulty <= 0.5f)
		{
			return "normal";
		}
		if (difficulty <= 0.75f)
		{
			return "hard";
		}
		return "very_hard";
	}

	private IssueBase OnStartIssue(in PotentialIssueData pid, Hero issueOwner)
	{
		return new TheSpyPartyIssue(issueOwner, pid.RelatedObject as Settlement);
	}

	public override void SyncData(IDataStore dataStore)
	{
	}
}
